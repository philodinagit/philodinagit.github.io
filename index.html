<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>やまづと山行記録</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f8f9fa; }
        header { background: #34495e; color: white; padding: 12px 15px; text-align: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        #search-container { background: #fff; padding: 10px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .search-row { display: flex; gap: 8px; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #count-display { font-size: 13px; color: #666; background: #f0f0f0; padding: 8px 12px; border-radius: 8px; white-space: nowrap; font-weight: bold; }

        #controls { height: 45px; background: #fff; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; overflow-x: auto; white-space: nowrap; padding: 0 10px; -webkit-overflow-scrolling: touch; }
        .filter-label { display: inline-flex; align-items: center; background: #e9ecef; padding: 6px 14px; margin-right: 8px; border-radius: 20px; font-size: 13px; cursor: pointer; border: 1px solid #ced4da; color: #495057; }
        .filter-label input { margin-right: 5px; }

        #map { height: calc(100vh - 175px); width: 100%; }

        .legend { background: white; padding: 8px 12px; line-height: 1.8; border-radius: 8px; font-size: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.2); }
        .legend i { width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 50%; vertical-align: middle; border: 1px solid #444; }
        .popup-link { display: inline-block; margin-top: 5px; color: #1a73e8; text-decoration: none; font-weight: bold; border-bottom: 1px solid #1a73e8; }
    </style>
</head>
<body>

<header>やまづと山行記録</header>

<div id="search-container">
    <div class="search-row">
        <input type="text" id="search-input" placeholder="山名、ルート、氏名で検索..." oninput="updateFilters()">
        <div id="count-display"><span id="match-count">0</span> / <span id="total-count">0</span> 件</div>
    </div>
</div>

<div id="controls">
    <div id="year-month-filters"></div>
</div>

<div id="map"></div>

<script>
    const map = L.map('map', { tap: true }).setView([36.0, 138.0], 7);

    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='
