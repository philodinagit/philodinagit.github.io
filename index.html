<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>„ÇÑ„Åæ„Å•„Å®Â±±Ë°åË®òÈå≤</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        body { margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background: #f8f9fa; }
        header { background: #34495e; color: white; padding: 12px 15px; text-align: center; font-weight: bold; font-size: 1.1rem; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }

        #search-container { background: #fff; padding: 10px; border-bottom: 1px solid #eee; display: flex; flex-direction: column; gap: 8px; }
        .search-row { display: flex; gap: 8px; align-items: center; }
        #search-input { flex-grow: 1; padding: 10px; border: 1px solid #ccc; border-radius: 8px; font-size: 16px; box-sizing: border-box; }
        #count-display { font-size: 13px; color: #666; background: #f0f0f0; padding: 8px 12px; border-radius: 8px; white-space: nowrap; font-weight: bold; }

        #controls { height: 45px; background: #fff; border-bottom: 1px solid #dee2e6; display: flex; align-items: center; overflow-x: auto; white-space: nowrap; padding: 0 10px; -webkit-overflow-scrolling: touch; }
        .filter-label { display: inline-flex; align-items: center; background: #e9ecef; padding: 6px 14px; margin-right: 8px; border-radius: 20px; font-size: 13px; cursor: pointer; border: 1px solid #ced4da; color: #495057; }
        .filter-label input { margin-right: 5px; }

        #map { height: calc(100vh - 175px); width: 100%; }

        .legend { background: white; padding: 8px 12px; line-height: 1.8; border-radius: 8px; font-size: 12px; box-shadow: 0 1px 6px rgba(0,0,0,0.2); }
        .legend i { width: 12px; height: 12px; display: inline-block; margin-right: 8px; border-radius: 50%; vertical-align: middle; border: 1px solid #444; }
        .popup-link { display: inline-block; margin-top: 5px; color: #1a73e8; text-decoration: none; font-weight: bold; border-bottom: 1px solid #1a73e8; }
    </style>
</head>
<body>

<header>„ÇÑ„Åæ„Å•„Å®Â±±Ë°åË®òÈå≤</header>

<div id="search-container">
    <div class="search-row">
        <input type="text" id="search-input" placeholder="Â±±Âêç„ÄÅ„É´„Éº„Éà„ÄÅÊ∞èÂêç„ÅßÊ§úÁ¥¢..." oninput="updateFilters()">
        <div id="count-display"><span id="match-count">0</span> / <span id="total-count">0</span> ‰ª∂</div>
    </div>
</div>

<div id="controls">
    <div id="year-month-filters"></div>
</div>

<div id="map"></div>

<script>
    const map = L.map('map', { tap: true }).setView([36.0, 138.0], 7);

    L.tileLayer('https://cyberjapandata.gsi.go.jp/xyz/std/{z}/{x}/{y}.png', {
        attribution: "<a href='https://maps.gsi.go.jp/development/ichiran.html' target='_blank'>Âú∞ÁêÜÈô¢Âú∞Âõ≥</a>",
        maxZoom: 18
    }).addTo(map);

    let allMarkers = [];
    const typeColors = {
        'Èõ™Â±±': '#00bfff',
        'Â≤©Áôª„Çä': '#ff4500',
        'Ê≤¢Áôª„Çä': '#ff8c00',
        'Â∞æÊ†πÊ≠©„Åç': '#32cd32',
        'default': '#7f8c8d'
    };

    const newIcon = L.icon({
        iconUrl: 'new.png',
        iconSize: [24, 24],
        iconAnchor: [12, 24],
        popupAnchor: [0, -22]
    });

    Papa.parse("yamazutoLog.csv", {
        download: true, header: true, skipEmptyLines: true,
        complete: function(results) {
            let data = results.data.filter(row => row.y && row.x);
            data.sort((a, b) => new Date(a.date) - new Date(b.date));
            document.getElementById('total-count').innerText = data.length;
            initMap(data);
        }
    });

    function linkify(text) {
        const urlPattern = /(https?:\/\/[^\s]+)/g;
        return text.replace(urlPattern, function(url) {
            return `<a href="${url}" target="_blank" rel="noopener noreferrer" class="popup-link">Ë©≥Á¥∞„É™„É≥„ÇØ üîó</a>`;
        });
    }

    function initMap(data) {
        const filtersDiv = document.getElementById('year-month-filters');
        const months = new Set();
        const now = new Date();
        const tenDaysAgo = new Date();
        tenDaysAgo.setDate(now.getDate() - 10);

        data.forEach(row => {
            const dateStr = row.date;
            const logDate = new Date(dateStr);
            const ym = dateStr.substring(0, 7); 
            months.add(ym);

            const type = row.type ? row.type.trim() : 'Êú™ÂàÜÈ°û';
            const color = typeColors[type] || typeColors['default'];
            const detailRaw = row.detail || "";
            const detailHtml = linkify(detailRaw);
            
            let marker;
            if (logDate >= tenDaysAgo && logDate <= now) {
                marker = L.marker([parseFloat(row.y), parseFloat(row.x)], { icon: newIcon });
            } else {
                marker = L.circleMarker([parseFloat(row.y), parseFloat(row.x)], {
                    radius: 9, fillColor: color, color: "#ffffff", weight: 1.5, fillOpacity: 0.85
                });
            }

            marker.bindPopup(`
                <div style="font-size:15px; min-width:160px;">
                    <b>${row.date}</b><br>
                    <div style="margin: 4px 0;">${detailHtml}</div>
                    <span style="font-size:11px; color:#666;">„Çø„Ç§„Éó: ${type}</span>
                </div>
            `);

            marker.ym = ym; 
            marker.detailStr = detailRaw.toLowerCase(); 
            
            marker.addTo(map);
            allMarkers.push(marker);
        });

        Array.from(months).sort().reverse().forEach(ym => {
            const label = document.createElement('label');
            label.className = 'filter-label';
            label.innerHTML = `<input type="checkbox" checked value="${ym}" onchange="updateFilters()"> ${ym.replace('-', 'Âπ¥')}Êúà`;
            filtersDiv.appendChild(label);
        });

        addLegend();
        updateFilters();
        
        if (allMarkers.length > 0) {
            const group = new L.featureGroup(allMarkers);
            map.fitBounds(group.getBounds().pad(0.2));
        }
    }

    function updateFilters() {
        const searchText = document.getElementById('search-input').value.toLowerCase();
        const checkedMonths = Array.from(document.querySelectorAll('#year-month-filters input:checked'))
                                   .map(cb => cb.value);

        let visibleCount = 0;
        allMarkers.forEach(marker => {
            const isMonthMatch = checkedMonths.includes(marker.ym);
            const isSearchMatch = marker.detailStr.includes(searchText);

            if (isMonthMatch && isSearchMatch) {
                map.addLayer(marker);
                visibleCount++;
            } else {
                map.removeLayer(marker);
            }
        });
        document.getElementById('match-count').innerText = visibleCount;
    }

    function addLegend() {
        const legend = L.control({position: 'bottomright'});
        legend.onAdd = function () {
            const div = L.DomUtil.create('div', 'legend');
            div.innerHTML += '<strong>ÁôªÂ±±„Çø„Ç§„Éó</strong><br>';
            // „Åì„Åì„ÅßÂá°‰æã„ÅÆnew.png„Çí16px„Å´Ë™øÊï¥
            div.innerHTML += `<img src="new.png" style="width:16px; height:16px; vertical-align:middle; margin-right:5px; margin-left:-2px;"> Áõ¥Ëøë10Êó•<br>`;
            for (let key in typeColors) {
                if(key === 'default') continue;
                div.innerHTML += `<i style="background: ${typeColors[key]}"></i> ${key}<br>`;
            }
            return div;
        };
        legend.addTo(map);
    }
</script>

</body>
</html>
